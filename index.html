<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Live Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b5cff">

<style>
body {
    margin: 0;
    background: #0f172a;
    color: #fff;
    font-family: Arial, sans-serif;
}
header {
    background: #0b5cff;
    padding: 12px;
    text-align: center;
    font-weight: bold;
}
#controls {
    padding: 10px;
    text-align: center;
}
button {
    padding: 10px 16px;
    border: none;
    background: #0b5cff;
    color: #fff;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
}
button:disabled {
    background: #555;
    cursor: not-allowed;
}
#link {
    margin-top: 10px;
    word-break: break-all;
    font-size: 14px;
    color: #22c55e;
}
input {
    padding: 10px;
    border: 1px solid #334155;
    background: #1e293b;
    color: #fff;
    font-size: 14px;
    border-radius: 6px;
    margin: 5px;
    width: 200px;
}
#map {
    width: 100%;
    height: 300px;
    margin-top: 10px;
}
.info-box {
    background: #1e293b;
    padding: 10px;
    margin: 10px;
    border-radius: 8px;
    text-align: left;
}
#videos {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    justify-content: center;
}
video {
    width: 200px;
    background: black;
    border-radius: 8px;
}
.status {
    font-size: 13px;
    color: #94a3b8;
    margin-top: 5px;
}
</style>
</head>

<body>
<header>游니 Live Cam</header>

<div id="controls">
    <button id="btnLink" disabled>游댕 Gerar Link</button>
    <button id="btnCopy" disabled>游늶 Copiar Link</button>
    <div class="status" id="status">Inicializando conex칚o...</div>
    <div id="link"></div>
    
    <div style="margin-top: 15px;">
        <input type="tel" id="recipientPhone" placeholder="Telefone destinat치rio">
        <button id="btnSendWhatsApp" disabled>游님 WhatsApp</button>
        <button id="btnSendSMS" disabled>游눫 SMS</button>
    </div>
</div>

<div id="locationInfo"></div>

<div id="videos"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
const videos = document.getElementById("videos");
const linkDiv = document.getElementById("link");
const btnLink = document.getElementById("btnLink");
const btnCopy = document.getElementById("btnCopy");
const btnSendWhatsApp = document.getElementById("btnSendWhatsApp");
const btnSendSMS = document.getElementById("btnSendSMS");
const statusEl = document.getElementById("status");
const locationInfo = document.getElementById("locationInfo");
const recipientPhone = document.getElementById("recipientPhone");

let peerId;
let localStream;
let generatedLink = "";
let localVideoAdded = false;
let remoteVideoAdded = false;

const peer = new Peer();

/* Abrir c칙mera */
async function startCamera() {
    if (localStream) return localStream;
    try {
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        if (!localVideoAdded) {
            addVideo(localStream, true, true);
            localVideoAdded = true;
        }
        return localStream;
    } catch (error) {
        statusEl.innerText = "丘멆잺 Erro ao acessar c칙mera: " + error.message;
        statusEl.style.color = "#ef4444";
        console.error("Camera error:", error);
        throw error;
    }
}

/* Adicionar v칤deo */
function addVideo(stream, muted = false, isLocal = false) {
    if (isLocal && localVideoAdded) return;
    if (!isLocal && remoteVideoAdded) return;
    
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    video.muted = muted;
    videos.appendChild(video);
    
    if (isLocal) localVideoAdded = true;
    else remoteVideoAdded = true;
}

/* Peer conectado */
peer.on("open", async id => {
    peerId = id;
    btnLink.disabled = false;
    statusEl.innerText = "Conectado. Aguardando visitante...";

    const params = new URLSearchParams(location.search);
    const room = params.get("r");

    if (room) {
        try {
            await startCamera();
            const call = peer.call(room, localStream);
            call.on("stream", remoteStream => {
                addVideo(remoteStream, false, false);
            });
            
            // Enviar localiza칞칚o para o sender
            const conn = peer.connect(room);
            conn.on('open', () => {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    
                    let address = "Carregando endere칞o...";
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                        const data = await response.json();
                        address = data.display_name || "Endere칞o n칚o encontrado";
                    } catch (e) {
                        address = "Erro ao buscar endere칞o";
                    }
                    
                    conn.send({ type: 'location', latitude, longitude, address });
                });
            });
        } catch (error) {
            statusEl.innerText = "Erro ao conectar com c칙mera";
        }
    }
});

/* Receber chamada */
peer.on("call", async call => {
    try {
        await startCamera();
        call.answer(localStream);
        call.on("stream", remoteStream => {
            addVideo(remoteStream, false, false);
            statusEl.innerText = "Visitante conectado";
        });
    } catch (error) {
        statusEl.innerText = "Erro ao acessar c칙mera para responder chamada";
    }
});

/* Receber dados de localiza칞칚o */
peer.on('connection', conn => {
    conn.on('data', data => {
        if (data.type === 'location') {
            locationInfo.innerHTML = `
                <div class="info-box">
                    <strong>游늸 Localiza칞칚o do Visitante</strong><br>
                    <strong>Endere칞o:</strong> ${data.address}<br>
                    <strong>Latitude:</strong> ${data.latitude.toFixed(6)}<br>
                    <strong>Longitude:</strong> ${data.longitude.toFixed(6)}
                </div>
                <div id="map"></div>
            `;
            
            const map = L.map('map').setView([data.latitude, data.longitude], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '춸 OpenStreetMap'
            }).addTo(map);
            L.marker([data.latitude, data.longitude]).addTo(map)
                .bindPopup('Visitante est치 aqui')
                .openPopup();
        }
    });
});

/* Gerar link */
btnLink.onclick = () => {
    generatedLink = `${location.origin}${location.pathname}?r=${peerId}`;
    linkDiv.innerText = generatedLink;
    statusEl.innerText = "Link gerado. Aguardando acesso...";
    btnCopy.disabled = false;
    btnSendWhatsApp.disabled = false;
    btnSendSMS.disabled = false;
};

/* Copiar link */
btnCopy.onclick = () => {
    navigator.clipboard.writeText(generatedLink);
    statusEl.innerText = "Link copiado!";
};

/* Enviar WhatsApp */
btnSendWhatsApp.onclick = () => {
    const phone = recipientPhone.value.replace(/\D/g, '');
    if (!phone) {
        alert("Digite o telefone do destinat치rio");
        return;
    }
    const message = encodeURIComponent(`Acesse este link: ${generatedLink}`);
    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
};

/* Enviar SMS */
btnSendSMS.onclick = () => {
    const phone = recipientPhone.value.replace(/\D/g, '');
    if (!phone) {
        alert("Digite o telefone do destinat치rio");
        return;
    }
    const message = encodeURIComponent(`Acesse este link: ${generatedLink}`);
    window.open(`sms:${phone}?body=${message}`);
};


</script>

</body>
</html>