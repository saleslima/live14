<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Live Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b5cff">

<style>
body {
    margin: 0;
    background: #0f172a;
    color: #fff;
    font-family: Arial, sans-serif;
}
header {
    background: #0b5cff;
    padding: 12px;
    text-align: center;
    font-weight: bold;
}
#controls {
    padding: 10px;
    text-align: center;
}
button {
    padding: 10px 16px;
    border: none;
    background: #0b5cff;
    color: #fff;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
}
button:disabled {
    background: #555;
    cursor: not-allowed;
}
#link {
    margin-top: 10px;
    word-break: break-all;
    font-size: 14px;
    color: #22c55e;
}
input {
    padding: 10px;
    border: 1px solid #334155;
    background: #1e293b;
    color: #fff;
    font-size: 14px;
    border-radius: 6px;
    margin: 5px;
    width: 200px;
}
#map {
    width: 100%;
    height: 300px;
    margin-top: 10px;
}
.info-box {
    background: #1e293b;
    padding: 10px;
    margin: 10px;
    border-radius: 8px;
    text-align: left;
}
#videos {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    justify-content: center;
}
video {
    width: 200px;
    max-width: 100%;
    background: black;
    border-radius: 8px;
}
.status {
    font-size: 13px;
    color: #94a3b8;
    margin-top: 5px;
}
#chat {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 300px;
    max-width: 100%;
    height: 400px;
    background: #1e293b;
    border-radius: 8px 8px 0 0;
    display: flex;
    flex-direction: column;
    border: 1px solid #334155;
    z-index: 1000;
}
#chatHeader {
    background: #0b5cff;
    padding: 10px;
    font-weight: bold;
    border-radius: 8px 8px 0 0;
}
#chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}
.message {
    margin-bottom: 10px;
    padding: 8px;
    background: #334155;
    border-radius: 6px;
    word-wrap: break-word;
}
.message.sent {
    background: #0b5cff;
    margin-left: 20px;
}
.message.received {
    background: #475569;
    margin-right: 20px;
}
#chatInput {
    display: flex;
    padding: 10px;
    gap: 5px;
}
#chatInput input {
    flex: 1;
    margin: 0;
}
#chatInput button {
    margin: 0;
    padding: 10px;
}

@media (max-width: 768px) {
    #controls {
        padding: 10px 5px;
    }
    
    button {
        padding: 12px 14px;
        font-size: 14px;
        margin: 3px;
        width: auto;
    }
    
    input {
        width: calc(100% - 20px);
        max-width: 300px;
        margin: 5px auto;
        display: block;
    }
    
    #controls > div {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    
    video {
        width: calc(50% - 10px);
        min-width: 150px;
    }
    
    #chat {
        width: 100%;
        height: 50vh;
        right: 0;
        left: 0;
        border-radius: 0;
    }
    
    #chatHeader {
        border-radius: 0;
    }
    
    #map {
        height: 200px;
    }
    
    .info-box {
        font-size: 13px;
        margin: 5px;
        padding: 8px;
    }
    
    #videos {
        padding: 5px;
        padding-bottom: calc(50vh + 10px);
    }
}

@media (max-width: 480px) {
    header {
        font-size: 14px;
        padding: 10px;
    }
    
    video {
        width: 100%;
    }
    
    button {
        font-size: 13px;
        padding: 10px 12px;
    }
    
    #link {
        font-size: 12px;
        padding: 0 10px;
    }
}
</style>
</head>

<body>
<header>ğŸ“¡ Live Cam</header>

<div id="controls">
    <button id="btnLink" disabled>ğŸ”— Gerar Link</button>
    <button id="btnCopy" disabled>ğŸ“‹ Copiar Link</button>
    <button id="btnToggleVideo" disabled>ğŸ‘ï¸ Ocultar Meu VÃ­deo</button>
    <button id="btnRecord" disabled>âºï¸ Gravar VÃ­deo</button>
    <div class="status" id="status">Inicializando conexÃ£o...</div>
    <div id="link"></div>
    
    <div style="margin-top: 15px;">
        <input type="tel" id="recipientPhone" placeholder="Telefone destinatÃ¡rio">
        <button id="btnSendWhatsApp" disabled>ğŸ“± WhatsApp</button>
        <button id="btnSendSMS" disabled>ğŸ’¬ SMS</button>
    </div>
</div>

<div id="locationInfo"></div>

<div id="videos"></div>

<div id="chat">
    <div id="chatHeader">ğŸ’¬ Chat</div>
    <div id="chatMessages"></div>
    <div id="chatInput">
        <input type="text" id="messageInput" placeholder="Digite uma mensagem...">
        <button id="btnSend">Enviar</button>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
const videos = document.getElementById("videos");
const linkDiv = document.getElementById("link");
const btnLink = document.getElementById("btnLink");
const btnCopy = document.getElementById("btnCopy");
const btnSendWhatsApp = document.getElementById("btnSendWhatsApp");
const btnSendSMS = document.getElementById("btnSendSMS");
const statusEl = document.getElementById("status");
const locationInfo = document.getElementById("locationInfo");
const recipientPhone = document.getElementById("recipientPhone");
const btnToggleVideo = document.getElementById("btnToggleVideo");
const btnRecord = document.getElementById("btnRecord");
const chatMessages = document.getElementById("chatMessages");
const messageInput = document.getElementById("messageInput");
const btnSend = document.getElementById("btnSend");

let peerId;
let localStream;
let generatedLink = "";
let localVideoAdded = false;
let remoteVideoAdded = false;
let localVideoElement = null;
let remoteVideoElement = null;
let videoVisible = true;
let isRecording = false;
let mediaRecorder = null;
let recordedChunks = [];
let dataConnection = null;

const peer = new Peer();

/* Abrir cÃ¢mera */
async function startCamera() {
    if (localStream) return localStream;
    try {
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        if (!localVideoAdded) {
            addVideo(localStream, true, true);
            localVideoAdded = true;
        }
        return localStream;
    } catch (error) {
        statusEl.innerText = "âš ï¸ Erro ao acessar cÃ¢mera: " + error.message;
        statusEl.style.color = "#ef4444";
        console.error("Camera error:", error);
        throw error;
    }
}

/* Adicionar vÃ­deo */
function addVideo(stream, muted = false, isLocal = false) {
    if (isLocal && localVideoAdded) return;
    if (!isLocal && remoteVideoAdded) return;
    
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    video.muted = muted;
    videos.appendChild(video);
    
    if (isLocal) {
        localVideoAdded = true;
        localVideoElement = video;
    } else {
        remoteVideoAdded = true;
        remoteVideoElement = video;
    }
}

/* Enviar mensagem no chat */
function sendMessage(text) {
    if (!text.trim() || !dataConnection) return;
    
    dataConnection.send({ type: 'chat', message: text });
    
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message sent';
    msgDiv.textContent = text;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    messageInput.value = '';
}

/* Receber mensagem no chat */
function receiveMessage(text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message received';
    msgDiv.textContent = text;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/* Peer conectado */
peer.on("open", async id => {
    peerId = id;
    btnLink.disabled = false;
    statusEl.innerText = "Conectado. Aguardando visitante...";

    const params = new URLSearchParams(location.search);
    const room = params.get("r");

    if (room) {
        try {
            await startCamera();
            const call = peer.call(room, localStream);
            call.on("stream", remoteStream => {
                addVideo(remoteStream, false, false);
            });
            
            // Enviar localizaÃ§Ã£o para o sender
            dataConnection = peer.connect(room);
            dataConnection.on('open', () => {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    
                    let address = "Carregando endereÃ§o...";
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                        const data = await response.json();
                        address = data.display_name || "EndereÃ§o nÃ£o encontrado";
                    } catch (e) {
                        address = "Erro ao buscar endereÃ§o";
                    }
                    
                    dataConnection.send({ type: 'location', latitude, longitude, address });
                });
            });
            
            dataConnection.on('data', data => {
                if (data.type === 'chat') {
                    receiveMessage(data.message);
                }
            });
        } catch (error) {
            statusEl.innerText = "Erro ao conectar com cÃ¢mera";
        }
    }
});

/* Receber chamada */
peer.on("call", async call => {
    try {
        await startCamera();
        call.answer(localStream);
        call.on("stream", remoteStream => {
            addVideo(remoteStream, false, false);
            statusEl.innerText = "Visitante conectado";
        });
    } catch (error) {
        statusEl.innerText = "Erro ao acessar cÃ¢mera para responder chamada";
    }
});

/* Receber dados de localizaÃ§Ã£o */
peer.on('connection', conn => {
    dataConnection = conn;
    conn.on('data', data => {
        if (data.type === 'location') {
            locationInfo.innerHTML = `
                <div class="info-box">
                    <strong>ğŸ“ LocalizaÃ§Ã£o do Visitante</strong><br>
                    <strong>EndereÃ§o:</strong> ${data.address}<br>
                    <strong>Latitude:</strong> ${data.latitude.toFixed(6)}<br>
                    <strong>Longitude:</strong> ${data.longitude.toFixed(6)}
                </div>
                <div id="map"></div>
            `;
            
            const map = L.map('map').setView([data.latitude, data.longitude], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            L.marker([data.latitude, data.longitude]).addTo(map)
                .bindPopup('Visitante estÃ¡ aqui')
                .openPopup();
            
            btnToggleVideo.disabled = false;
            btnRecord.disabled = false;
        } else if (data.type === 'chat') {
            receiveMessage(data.message);
        }
    });
});

/* Gerar link */
btnLink.onclick = async () => {
    try {
        await startCamera();
        generatedLink = `${location.origin}${location.pathname}?r=${peerId}`;
        linkDiv.innerText = generatedLink;
        statusEl.innerText = "Link gerado. Aguardando acesso...";
        btnCopy.disabled = false;
        btnSendWhatsApp.disabled = false;
        btnSendSMS.disabled = false;
    } catch (error) {
        statusEl.innerText = "Erro ao iniciar cÃ¢mera";
        statusEl.style.color = "#ef4444";
    }
};

/* Copiar link */
btnCopy.onclick = () => {
    navigator.clipboard.writeText(generatedLink);
    statusEl.innerText = "Link copiado!";
};

/* Enviar WhatsApp */
btnSendWhatsApp.onclick = () => {
    const phone = recipientPhone.value.replace(/\D/g, '');
    if (!phone) {
        alert("Digite o telefone do destinatÃ¡rio");
        return;
    }
    const message = encodeURIComponent(`Acesse este link: ${generatedLink}`);
    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
};

/* Enviar SMS */
btnSendSMS.onclick = () => {
    const phone = recipientPhone.value.replace(/\D/g, '');
    if (!phone) {
        alert("Digite o telefone do destinatÃ¡rio");
        return;
    }
    const message = encodeURIComponent(`Acesse este link: ${generatedLink}`);
    window.open(`sms:${phone}?body=${message}`);
};

/* Toggle vÃ­deo */
btnToggleVideo.onclick = () => {
    if (localVideoElement) {
        videoVisible = !videoVisible;
        localVideoElement.style.display = videoVisible ? 'block' : 'none';
        btnToggleVideo.textContent = videoVisible ? 'ğŸ‘ï¸ Ocultar Meu VÃ­deo' : 'ğŸ‘ï¸ Mostrar Meu VÃ­deo';
    }
};

/* Gravar vÃ­deo */
btnRecord.onclick = () => {
    if (!isRecording && remoteVideoElement && remoteVideoElement.srcObject) {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(remoteVideoElement.srcObject);
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gravacao_${Date.now()}.webm`;
            a.click();
            statusEl.innerText = 'GravaÃ§Ã£o salva!';
        };
        
        mediaRecorder.start();
        isRecording = true;
        btnRecord.textContent = 'â¹ï¸ Parar GravaÃ§Ã£o';
        btnRecord.style.background = '#ef4444';
        statusEl.innerText = 'Gravando...';
    } else if (isRecording && mediaRecorder) {
        mediaRecorder.stop();
        isRecording = false;
        btnRecord.textContent = 'âºï¸ Gravar VÃ­deo';
        btnRecord.style.background = '#0b5cff';
    }
};

/* Chat */
btnSend.onclick = () => {
    sendMessage(messageInput.value);
};

messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage(messageInput.value);
    }
});

</script>

</body>
</html>