<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Live Cam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b5cff">

<style>
body {
    margin: 0;
    background: #0f172a;
    color: #fff;
    font-family: Arial, sans-serif;
}
header {
    background: #0b5cff;
    padding: 12px;
    text-align: center;
    font-weight: bold;
}
#controls {
    padding: 10px;
    text-align: center;
}
button {
    padding: 10px 16px;
    border: none;
    background: #0b5cff;
    color: #fff;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
}
button:disabled {
    background: #555;
    cursor: not-allowed;
}
#link {
    margin-top: 10px;
    word-break: break-all;
    font-size: 14px;
    color: #22c55e;
}
input {
    padding: 10px;
    border: 1px solid #334155;
    background: #1e293b;
    color: #fff;
    font-size: 14px;
    border-radius: 6px;
    margin: 5px;
    width: 200px;
}
#map {
    width: 100%;
    height: 300px;
    margin-top: 10px;
}
.info-box {
    background: #1e293b;
    padding: 10px;
    margin: 10px;
    border-radius: 8px;
    text-align: left;
}
#videos {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    justify-content: center;
}
video {
    width: 200px;
    background: black;
    border-radius: 8px;
}
.status {
    font-size: 13px;
    color: #94a3b8;
    margin-top: 5px;
}
</style>
</head>

<body>
<header>üì° Live Cam</header>

<div id="controls">
    <button id="btnLink" disabled>üîó Gerar Link</button>
    <button id="btnCopy" disabled>üìã Copiar Link</button>
    <div class="status" id="status">Inicializando conex√£o...</div>
    <div id="link"></div>
    
    <div style="margin-top: 15px;">
        <input type="tel" id="recipientPhone" placeholder="Telefone destinat√°rio">
        <button id="btnSendWhatsApp" disabled>üì± WhatsApp</button>
        <button id="btnSendSMS" disabled>üí¨ SMS</button>
    </div>
</div>

<div id="locationInfo"></div>

<div id="videos"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
const videos = document.getElementById("videos");
const linkDiv = document.getElementById("link");
const btnLink = document.getElementById("btnLink");
const btnCopy = document.getElementById("btnCopy");
const btnSendWhatsApp = document.getElementById("btnSendWhatsApp");
const btnSendSMS = document.getElementById("btnSendSMS");
const statusEl = document.getElementById("status");
const locationInfo = document.getElementById("locationInfo");
const recipientPhone = document.getElementById("recipientPhone");

let peerId;
let localStream;
let generatedLink = "";
let localVideoAdded = false;

const peer = new Peer();

/* Abrir c√¢mera */
async function startCamera() {
    if (localStream) return localStream;
    try {
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        if (!localVideoAdded) {
            addVideo(localStream, true);
            localVideoAdded = true;
        }
        return localStream;
    } catch (error) {
        statusEl.innerText = "‚ö†Ô∏è Erro ao acessar c√¢mera: " + error.message;
        statusEl.style.color = "#ef4444";
        console.error("Camera error:", error);
        throw error;
    }
}

/* Adicionar v√≠deo */
function addVideo(stream, muted = false) {
    const video = document.createElement("video");
    video.srcObject = stream;
    video.autoplay = true;
    video.playsInline = true;
    video.muted = muted;
    videos.appendChild(video);
}

/* Peer conectado */
peer.on("open", async id => {
    peerId = id;
    btnLink.disabled = false;
    statusEl.innerText = "Conectado. Aguardando visitante...";

    const params = new URLSearchParams(location.search);
    const room = params.get("r");

    if (room) {
        try {
            await startCamera();
            const call = peer.call(room, localStream);
            call.on("stream", remoteStream => {
                addVideo(remoteStream);
            });
        } catch (error) {
            statusEl.innerText = "Erro ao conectar com c√¢mera";
        }
    }
});

/* Receber chamada */
peer.on("call", async call => {
    try {
        await startCamera();
        call.answer(localStream);
        call.on("stream", remoteStream => {
            addVideo(remoteStream);
            statusEl.innerText = "Visitante conectado";
        });
    } catch (error) {
        statusEl.innerText = "Erro ao acessar c√¢mera para responder chamada";
    }
});

/* Gerar link */
btnLink.onclick = () => {
    generatedLink = `${location.origin}${location.pathname}?r=${peerId}`;
    linkDiv.innerText = generatedLink;
    statusEl.innerText = "Link gerado. Aguardando acesso...";
    btnCopy.disabled = false;
    btnSendWhatsApp.disabled = false;
    btnSendSMS.disabled = false;
};

/* Copiar link */
btnCopy.onclick = () => {
    navigator.clipboard.writeText(generatedLink);
    statusEl.innerText = "Link copiado!";
};

/* Enviar WhatsApp */
btnSendWhatsApp.onclick = () => {
    const phone = recipientPhone.value.replace(/\D/g, '');
    if (!phone) {
        alert("Digite o telefone do destinat√°rio");
        return;
    }
    const message = encodeURIComponent(`Acesse este link: ${generatedLink}`);
    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
};

/* Enviar SMS */
btnSendSMS.onclick = () => {
    const phone = recipientPhone.value.replace(/\D/g, '');
    if (!phone) {
        alert("Digite o telefone do destinat√°rio");
        return;
    }
    const message = encodeURIComponent(`Acesse este link: ${generatedLink}`);
    window.open(`sms:${phone}?body=${message}`);
};

/* Capturar localiza√ß√£o do visitante */
const params = new URLSearchParams(location.search);
if (params.get("r")) {
    navigator.geolocation.getCurrentPosition(async position => {
        const { latitude, longitude } = position.coords;
        
        // Buscar endere√ßo via reverse geocoding
        let address = "Carregando endere√ßo...";
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
            const data = await response.json();
            address = data.display_name || "Endere√ßo n√£o encontrado";
        } catch (e) {
            address = "Erro ao buscar endere√ßo";
        }
        
        // Exibir informa√ß√µes
        locationInfo.innerHTML = `
            <div class="info-box">
                <strong>üìç Localiza√ß√£o do Visitante</strong><br>
                <strong>Endere√ßo:</strong> ${address}<br>
                <strong>Latitude:</strong> ${latitude.toFixed(6)}<br>
                <strong>Longitude:</strong> ${longitude.toFixed(6)}
            </div>
            <div id="map"></div>
        `;
        
        // Criar mapa
        const map = L.map('map').setView([latitude, longitude], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        L.marker([latitude, longitude]).addTo(map)
            .bindPopup('Visitante est√° aqui')
            .openPopup();
    }, error => {
        locationInfo.innerHTML = `
            <div class="info-box">
                <strong>‚ö†Ô∏è N√£o foi poss√≠vel obter localiza√ß√£o</strong><br>
                Erro: ${error.message}
            </div>
        `;
    });
}
</script>

</body>
</html>